<script type="text/javascript">
    RED.nodes.registerType('redmatic-webapp', {
        category: 'redmatic',
        defaults: {
            ccuConfig: {value: 'localhost', type: 'ccu-connection', required: true},
            name: {value: 'app', required: true},
            title: {value: 'RedMatic WebApp', required: true},
            theme: {value: ''},
            replaceChannelNames: {value: true},
            showHome: {value: false},
            showRooms: {value: true},
            showFunctions: {value: true},
            showSysvar: {value: false},
            showProgram: {value: true},
            showSystem: {value: false},
            rooms: {value: []}
        },
        inputs: 0,
        outputs: 0,
        icon: 'ccu.png',
        color: '#4691BA',
        paletteLabel: 'WebApp',
        align: 'left',
        label() {
            return 'WebApp' + ((this.name && this.name !== 'app') ? ' ' + this.name : '');
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare() {
            const $nodeInputName = $('#node-input-name');
            const $nodeInputCcuConfig = $('#node-input-ccuConfig');
            const $appUrl = $('#app-url');

            $nodeInputName.on('change', () => {
                $appUrl.html('<a href="app/?/' + $nodeInputName.val() + '" target="_blank">' + location.origin + location.pathname +  'app/?/' + $nodeInputName.val() + '</a>');
            });

            $('ol.rooms').editableList({
                sortable: true,
                addButton: false,
                removeable: false,
                addItem: (row, index, room) => {
                    $(row).html('<input class="enabled" type="checkbox"' + (room.hidden ? '' : ' checked') + '>');
                    $(row).append('<span class="name">' + room.name + '</span>');
                    $(row).append('<input class="icon" value="' + (room.icon || '') + '">');
                }
            });

            function loadConfig() {
                let data;
                this.rooms = this.rooms || [];
                const nodeId = $nodeInputCcuConfig.val();
                const url = 'ccu?type=rooms&config=' + nodeId;
                $.getJSON(url, d => {
                    data = d;
                    console.log('data.rooms', data.rooms);
                    console.log('this.rooms', this.rooms);
                    const rooms = [];
                    const knownRooms = [];
                    this.rooms.forEach(room => {
                        if (data.rooms.includes(room.name)) {
                            console.log('known', room)
                            rooms.push(room);
                            knownRooms.push(room.name);
                        }
                    });
                    data.rooms.forEach(room => {
                        if (!knownRooms.includes(room)) {
                            console.log('unknown', room);
                            rooms.push({
                                name: room
                            });
                        }
                    });
                    $('ol.rooms').editableList('addItems', rooms);
                });

            }

            loadConfig.apply(this);



        },
        oneditsave() {
            /*
            let collision;
            RED.nodes.eachNode(n => {
                if (n.type === 'redmatic-webapp') {
                    console.log(this.id, n.id, this.name, n.name);
                    if (this.id !== n.id && this.name === n.name) {
                        this.log.error('Konifguration mit Name ' + this.name + ' bereits vorhanden!');
                        collision = true;
                    }
                }
            });
            if (collision) {
                return false;
            }
            */
            const rooms = [];
            $('ol.rooms').editableList('items').each(function (item) {
                rooms.push({
                    name: $(this).find('.name').html(),
                    hidden: !$(this).find('.enabled').is(':checked'),
                    icon: $(this).find('.icon').val()
                });
            });
            this.rooms = rooms;

        }
    });
</script>

<script type="text/x-red" data-template-name="redmatic-webapp">

    <div class="form-row">
        <label for="node-input-ccuConfig"><i class="icon-globe"></i> CCU</label>
        <input type="text" id="node-input-ccuConfig">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-globe"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="app-url"> App URL</label>
        <span id="app-url" style="width: 70%; display: inline-block;"></span>
    </div>
    <div class="form-row">
        <label for="node-input-title"><i class="icon-globe"></i> Title</label>
        <input type="text" id="node-input-title">
    </div>
    <div class="form-row">
        <label for="node-input-theme"><i class="icon-globe"></i> Theme</label>
        <select id="node-input-theme">
            <option value="">Bright Blue</option>
            <option value="theme-dark">Dark Orange</option>
        </select>
    </div>
    <div class="form-row" style="text-align: top">
        <label for="item-options" style="vertical-align: top;"><i class="icon-globe"></i> Optionen</label>
        <div id="item-options" style="display: inline-block; position: relative; width: 70%;">
            <div><label style="width: auto" for="node-input-replaceChannelNames"><input style="width: auto" type="checkbox" id="node-input-replaceChannelNames"> Kanalnamen verkürzen</label></div>
        </div>
    </div>
    <div class="form-row" style="text-align: top">
        <label for="menu" style="vertical-align: top;"><i class="icon-globe"></i> Menü</label>
        <div id="menu" style="display: inline-block; position: relative; width: 70%;">
            <div><label style="width: auto" for="node-input-showHome"><input style="width: auto" type="checkbox" id="node-input-showHome" disabled> Übersicht</label></div>
            <div><label style="width: auto" for="node-input-showRooms"><input style="width: auto" type="checkbox" id="node-input-showRooms"> Räume</label></div>
            <div><label style="width: auto" for="node-input-showFunctions"><input style="width: auto" type="checkbox" id="node-input-showFunctions"> Gewerke</label></div>
            <div><label style="width: auto" for="node-input-showSysvar"><input style="width: auto" type="checkbox" id="node-input-showSysvar" disabled> Variablen</label></div>
            <div><label style="width: auto" for="node-input-showProgram"><input style="width: auto" type="checkbox" id="node-input-showProgram"> Programme</label></div>
            <div><label style="width: auto" for="node-input-showSystem"><input style="width: auto" type="checkbox" id="node-input-showSystem" disabled> System</label></div>
        </div>
    </div>
    <div class="form-row" style="text-align: top">
        <label for="menu" style="vertical-align: top;"><i class="icon-globe"></i> Räume</label>
        <div id="menu" style="display: inline-block; position: relative; width: 70%;">
            <ol class="rooms"></ol>
        </div>
    </div>
   <div class="form-row" style="text-align: top">
        <label for="menu" style="vertical-align: top;"><i class="icon-globe"></i> Gewerke</label>
        <div id="menu" style="display: inline-block; position: relative; width: 70%;">
            <ol class="functions"></ol>
        </div>
    </div>
    <style>
        input.enabled {
            width: 30px;
            margin-top: -3px;
        }
        input.icon {
            max-width: 112px;
            float: right;
            margin-top: -4px;
        }
    </style>
</script>

<script type="text/x-red" data-help-name="redmatic-webapp">

</script>